name: e2e-test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Start Airflow with Docker Compose
        run: |
          docker-compose up -d
          docker ps -a

      - name: Initialize Airflow DB
        run: |
          docker exec mogiproject_airflow-scheduler_1 airflow db init

      - name: Wait for Airflow webserver to be ready
        run: |
          for i in {1..20}; do
            if docker logs mogiproject_airflow-webserver_1 2>&1 | grep -q "Listening at:"; then
              echo "✅ Webserver is ready"
              exit 0
            fi
            echo "⏳ Waiting for webserver... ($i/20)"
            sleep 15
          done
          echo "❌ Webserver did not start in time. Dumping logs..."
          docker logs mogiproject_airflow-webserver_1
          exit 1

      - name: Trigger DAG run
        run: |
          docker exec mogiproject_airflow-webserver_1 \
            airflow dags trigger -d industry_metrics_from_input

      - name: Run pytest (check output files)
        run: |
          pytest -v tests/

      # --- AWS CLI & S3 検証 ---
      - name: Install AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli

      - name: Verify file uploaded to AWS S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-1
        run: |
          aws s3 ls s3://my-s3-bucket/metrics/ --recursive

      # --- GCP CLI & GCS 検証 ---
      - name: Install gcloud CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y google-cloud-cli

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Verify file uploaded to GCS
        run: |
          gsutil ls gs://my-gcs-bucket-2025-demo/metrics/

      # --- BigQuery 検証 ---
      - name: Verify data loaded into BigQuery
        run: |
          bq query --project_id=striking-yen-470200-u3 --use_legacy_sql=false \
            "SELECT * FROM \`sales_dataset.retail_metrics\` LIMIT 5"
