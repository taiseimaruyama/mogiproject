name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Start Airflow with Docker Compose
        run: |
          docker-compose up -d postgres redis
          docker-compose up -d airflow-webserver airflow-scheduler
          echo "⏳ Waiting for Airflow services..."
          sleep 60

      - name: Initialize Airflow DB
        run: |
          docker-compose run --rm airflow-cli db migrate

      - name: Wait for Airflow webserver to be ready
        run: |
          for i in {1..10}; do
            if docker logs mogiproject_airflow-webserver_1 2>&1 | grep -q "Listening at: http"; then
              echo "✅ Webserver is ready"
              exit 0
            fi
            echo "⏳ Waiting for webserver... ($i/10)"
            sleep 15
          done
          echo "❌ Webserver did not start in time"
          exit 1

      - name: Trigger DAG run
        run: |
          docker exec mogiproject_airflow-webserver_1 \
            airflow dags trigger -d industry_metrics_from_input

      - name: Run pytest (check output files)
        run: |
          pip install pytest pandas
          pytest -v

      # ---------- AWS S3 ----------
      - name: Install AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli

      - name: Verify file uploaded to AWS S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-1
        run: |
          aws s3 ls s3://my-s3-bucket/metrics/ads_metrics.csv

      # ---------- Google Cloud ----------
      - name: Install gcloud CLI
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-cli

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Verify file uploaded to GCS
        run: |
          gsutil ls gs://my-gcs-bucket-2025-demo/metrics/retail_metrics.csv

      - name: Verify data loaded into BigQuery
        run: |
          bq query --project_id=striking-yen-470200-u3 --nouse_legacy_sql \
            'SELECT COUNT(*) AS cnt FROM `sales_dataset.retail_metrics`'
