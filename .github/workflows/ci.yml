name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: airflow
          POSTGRES_PASSWORD: airflow
          POSTGRES_DB: airflow
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U airflow"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      AIRFLOW_FERNET_KEY: ${{ secrets.AIRFLOW_FERNET_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AIRFLOW_UID: 50000

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        run: docker compose version

      - name: Build and start services
        run: |
          docker compose up -d --build
          # æ–¹æ³•A: èµ·å‹•å¾…æ©Ÿï¼ˆsleep 20ï¼‰
          sleep 20
          # æ–¹æ³•B: DBãƒã‚§ãƒƒã‚¯ï¼ˆ1å›ã ã‘ï¼‰
          docker compose run --rm airflow-cli airflow db check

      - name: Run Airflow init
        run: docker compose run --rm airflow-init

      - name: Show airflow-init logs
        run: docker compose logs airflow-init

      - name: Run scheduler
        run: docker compose up -d airflow-scheduler

      - name: Run worker
        run: docker compose up -d airflow-worker

      - name: Run webserver
        run: docker compose up -d airflow-webserver

      - name: Show scheduler logs
        run: docker compose logs airflow-scheduler

      - name: Show worker logs
        run: docker compose logs airflow-worker

      # ğŸ‘‡ ã“ã“ã‚’è¿½åŠ ï¼šã‚¿ã‚¹ã‚¯ã®è©³ç´°ãƒ­ã‚°ã‚’æ˜ã‚Šã«è¡Œã
      - name: Show task logs (preprocess_retail)
        run: |
          docker compose run --rm airflow-cli \
            airflow tasks logs industry_metrics_full_dag preprocess_retail ci_run_17490581132 || true

      - name: Show task logs (preprocess_ads)
        run: |
          docker compose run --rm airflow-cli \
            airflow tasks logs industry_metrics_full_dag preprocess_ads ci_run_17490581132 || true

      # DAG å…¨ä½“ã‚’1å›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Trigger DAG
        run: |
          docker compose run --rm airflow-cli \
            airflow dags test industry_metrics_full_dag 2025-09-05
