name: CI Airflow DAG

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker
      run: docker --version

    - name: Start Airflow
      run: docker compose up -d --build

    - name: Wait for Airflow Init
      run: |
        echo "Waiting for Airflow DB init..."
        sleep 60

    - name: Show airflow-init logs (always)
      if: always()
      run: docker compose logs airflow-init

    - name: Trigger DAG run
      run: |
        run_id=$(docker compose run --rm airflow-cli \
          airflow dags trigger industry_metrics_full_dag --run-id ci_run_${GITHUB_RUN_ID})
        echo "Triggered: $run_id"

    - name: Show DAG runs (always)
      if: always()
      run: docker compose run --rm airflow-cli \
        airflow dags list-runs -d industry_metrics_full_dag --no-backfill

    - name: Show task states for latest DAG run
      run: |
        run_id=$(docker compose run --rm airflow-cli \
          airflow dags list-runs -d industry_metrics_full_dag --no-backfill --output table | awk 'NR==3 {print $2}')
        if [ -z "$run_id" ]; then
          echo "⚠️ No DAG run found, skipping task states"
        else
          docker compose run --rm airflow-cli \
            airflow tasks states-for-dag-run industry_metrics_full_dag $run_id
        fi

    - name: Check output files
      run: ls -lh ./output

    - name: Upload output files to S3
      run: aws s3 cp ./output s3://domoproject/ --recursive

    - name: Stop Docker
      if: always()
      run: docker compose down -v
