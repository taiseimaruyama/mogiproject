name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Start Airflow with Docker Compose
        run: |
          docker-compose up -d
          echo "⏳ Waiting for Airflow containers..."
          sleep 60
          docker ps -a

      - name: Wait for Airflow webserver to be ready
        run: |
          for i in {1..20}; do
            if docker logs mogiproject_airflow-webserver_1 2>&1 | grep "Listening at"; then
              echo "✅ Airflow webserver is ready"
              break
            fi
            echo "⏳ Waiting ($i)..."
            sleep 10
          done

      - name: Trigger DAG run
        run: |
          docker exec mogiproject_airflow-webserver_1 \
            airflow dags trigger -d industry_metrics_from_input
          echo "⏳ Waiting for DAG execution..."
          sleep 120

      - name: Run pytest (check output files)
        run: |
          pip install pytest pandas
          pytest -v

      # ---------- AWS S3 ----------
      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install

      - name: Verify file uploaded to AWS S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-1
        run: |
          aws s3 ls s3://domoproject/metrics/ || echo "⚠️ S3 upload not found"

      # ---------- GCP ----------
      - name: Install gcloud CLI
        run: |
          sudo apt-get update && sudo apt-get install -y google-cloud-cli

      - name: Authenticate to GCP
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/gcp-key.json
        run: |
          echo '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}' > $GOOGLE_APPLICATION_CREDENTIALS
          gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          gcloud config set project striking-yen-470200-u3

      - name: Verify file uploaded to GCS
        run: |
          gsutil ls gs://my-gcs-bucket-2025-demo/metrics/ || echo "⚠️ GCS upload not found"

      - name: Verify data loaded into BigQuery
        run: |
          bq query --use_legacy_sql=false \
            'SELECT * FROM `striking-yen-470200-u3.sales_dataset.retail_metrics` LIMIT 5'
